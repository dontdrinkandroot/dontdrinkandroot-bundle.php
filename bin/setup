#!/bin/bash

function setAcl() {
    sudo setfacl -Rn -m u:www-data:rwX -m u:`whoami`:rwX $1
    sudo setfacl -dRn -m u:www-data:rwX -m u:`whoami`:rwX $1
    sudo chown -R :www-data $1
    sudo chmod -R g+w $1
    sudo chmod g+ws $1
    sudo setfacl -dR -m g::rwX $1
}

function maintenanceOn() {
    echo "Maintenance ON"
    touch web/IN_MAINTENANCE_MODE
}

function maintenanceOff() {
    echo "Maintenance OFF"
    rm web/IN_MAINTENANCE_MODE
}

function maintenance() {
    case $1 in
        "on")
            maintenanceOn
            ;;
        "off")
            maintenanceOff
            ;;
         *)
            echo "Valid parameters are 'on' or 'off'"
            ;;
    esac
}

function setPermissions() {
    echo "Setting Permissions"
    sudo chown :www-data var/
    setAcl var/logs/
    setAcl var/cache/
}

function printUsage() {
    echo "TODO: Show usage"
}

function update() {
    echo "Updating"
    maintenanceOn && \
    git pull && \
    composer install && \
    bin/console assetic:dump && \
    bin/console doctrine:cache:clear-metadata && \
    bin/console doctrine:schema:update --dump-sql
}

function install() {
    echo "Installing"
    composer install --optimize-autoloader && \
    bin/console --env=prod assetic:dump && \
    maintenanceOff
}

function runTests() {
    bin/console --env="test" doctrine:schema:update --force
    bin/phpcs --standard=psr2 --ignore=*.js,*.css ./src

    echo ""
    echo "=================="
    echo "Running UNIT Tests"
    echo "=================="
    echo ""
    bin/phpunit -c app/ --testsuite "Unit Tests"

    echo ""
    echo "========================="
    echo "Running INTEGRATION Tests"
    echo "========================="
    echo ""
    bin/phpunit -c app/ --testsuite "Integration Tests"
}

if [ 0 -eq "$#" ]; then
    printUsage
fi

while getopts uitpm:h option; do
    case $option in
        "u")
            update
            ;;
        "i")
            install
            ;;
        "m")
            maintenance $OPTARG
            ;;
        "h")
            printUsage
            ;;
        "p")
            setPermissions
            ;;
        "t")
            runTests
            ;;
        \?)
            printUsage
            exit 1
            ;;
        :)
            printUsage
            exit 1
            ;;
    esac
done
